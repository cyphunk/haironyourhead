<html>
<head>
<script src="http://hoyh.nocompany.co/socket.io/socket.io.js"></script>

<script>
    console.log('it may take a few seconds for the first connection')

    // localStorage.debug='*';
    localStorage.debug='';

    // var socket = io.connect('http://hoyh.nocompany.co');
    var socket = io.connect('');

    var update_every_ms = 10000
    socket.on('connect', function () {
        console.log('### connected')
        socket.emit('get_samples', null, 'last')
        window.setInterval(function(){
            // 'last' returns only the last element of each devices samples array
            socket.emit('get_samples', null, 'last')
        }, update_every_ms)
    });

    socket.on('samples', function(devices){
        console.log('### samples')
        console.log(devices)
        update_device_boxes(devices)
    });


    // generate table
    // it might be good to make this dynamicly change based on number of devices available
    var rows = 4
    var cols = 5
    var html = ''
    for (var i = 1; i<=rows; i++) {
        html += "<tr>"
        for (var j=1; j<=cols; j++)
            html += "<td id="+j+" class=cell></td>"
        html += "</tr>\n"
    }
    var table = document.createElement('table')
    var cells;
    table.innerHTML = html
    window.onload = function () {
        document.getElementsByTagName('body')[0].appendChild(table)
        cells = document.getElementsByClassName('cell')
    }
    // update table:
    var values = {} // use this rather than DOM to track if value requires change
    function update_device_boxes(devices) {
        console.log('update_device_boxes')
        Object.keys(devices).forEach(function(k) {
            // we called get_samples 'last' which means there will always only be the last entry returned
            if (devices[k].bpm.samples.length <= 0)
                return
            if (!values.hasOwnProperty(k) || devices[k].bpm.samples[0][1] != values[k])
                values[k] = devices[k].bpm.samples[0][1]
            else
                return
            console.log(k)
            cells[k].innerText = values[k]
        });
    }

</script>

<script>
</script>
<style>
table { width: 100%; height: 100% }
.cell { width: 20%; height:25%; background-color: #efefef; }
</style>
</head>
<body>
</body>
</html>
